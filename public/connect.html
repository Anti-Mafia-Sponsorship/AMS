<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMS Token - –°–≤—ä—Ä–∂–∏ Wallet</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #0a0e27; color: #fff; }
        nav { background: #1a1f3a; padding: 20px; text-align: center; }
        nav a { color: #667eea; text-decoration: none; margin: 0 15px; font-size: 1.1em; }
        nav a:hover { color: #fff; }
        .container { max-width: 800px; margin: 100px auto; padding: 40px; }
        .connect-box { background: #1a1f3a; padding: 50px; border-radius: 20px; text-align: center; }
        .connect-box h1 { font-size: 2.5em; color: #667eea; margin-bottom: 30px; }
        .wallet-button { 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 30px 20px; 
            border-radius: 20px; 
            font-size: 1.1em; 
            font-weight: bold; 
            text-decoration: none; 
            border: none; 
            cursor: pointer; 
            transition: transform 0.3s, box-shadow 0.3s;
            min-height: 140px;
        }
        .wallet-button:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4); 
        }
        .wallet-button:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none;
        }
        .wallet-icon { 
            font-size: 3em; 
            margin-bottom: 10px;
            display: block;
        }
        .info-box { background: #0a0e27; padding: 30px; border-radius: 15px; margin-top: 40px; text-align: left; }
        .info-box h3 { color: #667eea; margin-bottom: 15px; }
        .info-box p { color: #b8c5d6; line-height: 1.8; margin-bottom: 10px; }
        .status { background: #ffc107; color: #000; padding: 20px; border-radius: 10px; margin-top: 30px; font-weight: bold; display: none; }
        .connected { background: #4caf50; color: #fff; }
        .error { background: #ff5722; color: #fff; }
        .debug-info { background: #1a1f3a; padding: 20px; border-radius: 10px; margin-top: 20px; font-family: monospace; font-size: 0.9em; display: none; }
    </style>
</head>
<body>
    <nav>
        <a href="index.html">–ù–∞—á–∞–ª–æ</a>
        <a href="connect.html">–°–≤—ä—Ä–∂–∏ Wallet</a>
        <a href="rules.html">–ü—Ä–∞–≤–∏–ª–∞</a>
        <a href="donate.html">–î–∞—Ä—è–≤–∞–π</a>
        <a href="contact.html">–ö–æ–Ω—Ç–∞–∫—Ç–∏</a>
    </nav>

    <div class="container">
        <div class="connect-box">
            <h1>üîó –°–≤—ä—Ä–∂–∏ –ü–æ—Ä—Ç—Ñ–µ–π–ª–∞ —Å–∏</h1>
            <p style="color: #b8c5d6; margin-bottom: 40px; font-size: 1.2em;">
                –ò–∑–±–µ—Ä–∏ wallet –∑–∞ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ –∫—ä–º AMS Token
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <button class="wallet-button" onclick="connectMetaMask()" id="metamaskBtn">
                    <span class="wallet-icon">ü¶ä</span><br>
                    <span style="font-size: 0.9em;">MetaMask</span>
                </button>
                
                <button class="wallet-button" onclick="connectTrustWallet()" id="trustBtn">
                    <span class="wallet-icon">üõ°Ô∏è</span><br>
                    <span style="font-size: 0.9em;">Trust Wallet</span>
                </button>
                
                <button class="wallet-button" onclick="connectBinanceWallet()" id="binanceBtn">
                    <span class="wallet-icon">üî∂</span><br>
                    <span style="font-size: 0.9em;">Binance Wallet</span>
                </button>
                
                <button class="wallet-button" onclick="connectCoinbaseWallet()" id="coinbaseBtn">
                    <span class="wallet-icon">üîµ</span><br>
                    <span style="font-size: 0.9em;">Coinbase Wallet</span>
                </button>
                
                <button class="wallet-button" onclick="connectWalletConnect()" id="walletconnectBtn">
                    <span class="wallet-icon">üîó</span><br>
                    <span style="font-size: 0.9em;">WalletConnect</span>
                </button>
            </div>
            
            <div id="status" class="status"></div>
            
            <div id="debugInfo" class="debug-info"></div>
        </div>
        
        <div class="info-box">
            <h3>‚ÑπÔ∏è –ö–∞–∫ —Ä–∞–±–æ—Ç–∏ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ—Ç–æ?</h3>
            <p>üì± Wallet-—ä—Ç —Ç–∏ —Å–µ —Å–≤—ä—Ä–∑–≤–∞ —Å AMS Token –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ç–∞</p>
            <p>üîê –ú–æ–∂–µ—à –¥–∞ –¥–∞—Ä–∏—à BNB –∏ –¥–∞ –ø–æ–ª—É—á–∞–≤–∞—à AMS —Ç–æ–∫–µ–Ω–∏</p>
            <p>üí∞ –°–ª–µ–¥ –ø–æ–ª—É—á–∞–≤–∞–Ω–µ –Ω–∞ —Ç–æ–∫–µ–Ω–∏, –º–æ–∂–µ—à –¥–∞ –≥–∏ sell-–≤–∞—à –æ–±—Ä–∞—Ç–Ω–æ –∑–∞ BNB (–ø—Ä–∏ unlock –ø–µ—Ä–∏–æ–¥)</p>
            <p>üîí –°–≤—ä—Ä–∑–≤–∞–Ω–µ—Ç–æ –Ω–∞ wallet –ù–ï –¥–∞–≤–∞ –¥–æ—Å—Ç—ä–ø –¥–æ —Å—Ä–µ–¥—Å—Ç–≤–∞—Ç–∞ —Ç–∏!</p>
            
            <div style="margin-top: 30px; padding: 20px; background: #667eea; border-radius: 10px;">
                <h3 style="color: #fff; margin-bottom: 10px;">üì• –ù—è–º–∞—à MetaMask?</h3>
                <p style="color: #fff;">–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–π –≥–æ –±–µ–∑–ø–ª–∞—Ç–Ω–æ:</p>
                <a href="https://metamask.io/download/" target="_blank" style="display: inline-block; margin-top: 10px; background: #fff; color: #667eea; padding: 10px 20px; border-radius: 10px; text-decoration: none; font-weight: bold;">
                    –°–≤–∞–ª–∏ MetaMask
                </a>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 40px;">
            <a href="donate.html" class="wallet-button" style="display: inline-block;">
                –ü—Ä–æ–¥—ä–ª–∂–∏ –∫—ä–º –î–∞—Ä–µ–Ω–∏—è ‚Üí
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script>
        let web3;
        let account;
        
        const BSC_MAINNET = 56;
        const BSC_TESTNET = 97;
        
        // Debug info
        function updateDebug(msg) {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML += msg + '<br>';
            debugDiv.style.display = 'block';
            console.log(msg);
        }
        
        // Check MetaMask on page load
        window.addEventListener('load', function() {
            updateDebug('üîç Checking for wallet providers...');
            
            // Check multiple ways
            const hasEthereum = typeof window.ethereum !== 'undefined';
            const hasWeb3 = typeof window.web3 !== 'undefined';
            const hasMetaMask = window.ethereum && window.ethereum.isMetaMask;
            const hasTrust = window.ethereum && window.ethereum.isTrust;
            const hasBinance = window.BinanceChain;
            const hasCoinbase = window.ethereum && window.ethereum.isCoinbaseWallet;
            
            updateDebug('window.ethereum: ' + hasEthereum);
            updateDebug('MetaMask: ' + hasMetaMask);
            updateDebug('Trust Wallet: ' + hasTrust);
            updateDebug('Binance Wallet: ' + hasBinance);
            updateDebug('Coinbase Wallet: ' + hasCoinbase);
            
            // Highlight available wallets
            if (hasMetaMask) {
                updateDebug('‚úÖ MetaMask detected!');
                document.getElementById('metamaskBtn').style.borderColor = '#4caf50';
                document.getElementById('metamaskBtn').style.border = '3px solid #4caf50';
            }
            if (hasTrust) {
                updateDebug('‚úÖ Trust Wallet detected!');
                document.getElementById('trustBtn').style.borderColor = '#4caf50';
                document.getElementById('trustBtn').style.border = '3px solid #4caf50';
            }
            if (hasBinance) {
                updateDebug('‚úÖ Binance Wallet detected!');
                document.getElementById('binanceBtn').style.borderColor = '#4caf50';
                document.getElementById('binanceBtn').style.border = '3px solid #4caf50';
            }
            if (hasCoinbase) {
                updateDebug('‚úÖ Coinbase Wallet detected!');
                document.getElementById('coinbaseBtn').style.borderColor = '#4caf50';
                document.getElementById('coinbaseBtn').style.border = '3px solid #4caf50';
            }
            
            if (!hasEthereum && !hasBinance) {
                updateDebug('‚ùå No wallet provider found');
                showStatus('‚ùå –ù—è–º–∞ –æ—Ç–∫—Ä–∏—Ç wallet! –ú–æ–ª—è –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–π MetaMask, Trust Wallet –∏–ª–∏ –¥—Ä—É–≥.', 'error');
            }
            
            // Check if already connected
            if (localStorage.getItem('walletConnected') === 'true') {
                const address = localStorage.getItem('walletAddress');
                const walletType = localStorage.getItem('walletType') || 'Unknown';
                if (address) {
                    showStatus(`‚úÖ –í–µ—á–µ —Å–≤—ä—Ä–∑–∞–Ω —Å ${walletType}: ${address.substring(0, 6)}...${address.substring(38)}`, 'connected');
                }
            }
        });
        
        async function connectMetaMask() {
            updateDebug('üîÑ Attempting to connect...');
            
            // Check #1: window.ethereum exists
            if (typeof window.ethereum === 'undefined') {
                updateDebug('‚ùå window.ethereum is undefined');
                showStatus('‚ùå MetaMask –Ω–µ –µ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω!', 'error');
                
                // Offer to open MetaMask download page
                if (confirm('MetaMask –Ω–µ –µ –æ—Ç–∫—Ä–∏—Ç.\n\n–ò—Å–∫–∞—à –ª–∏ –¥–∞ –≥–æ —Å–≤–∞–ª–∏—à —Å–µ–≥–∞?')) {
                    window.open('https://metamask.io/download/', '_blank');
                }
                return;
            }
            
            updateDebug('‚úÖ window.ethereum exists');
            
            // Check #2: isMetaMask flag
            if (!window.ethereum.isMetaMask) {
                updateDebug('‚ö†Ô∏è Not MetaMask, but has ethereum provider');
                // Continue anyway - might be another wallet
            }
            
            try {
                updateDebug('üì° Requesting accounts...');
                
                // Request account access
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                updateDebug('‚úÖ Accounts received: ' + accounts.length);
                
                if (!accounts || accounts.length === 0) {
                    throw new Error('No accounts returned');
                }
                
                web3 = new Web3(window.ethereum);
                account = accounts[0];
                
                updateDebug('‚úÖ Connected to: ' + account);
                
                // Check network
                const chainId = await web3.eth.getChainId();
                updateDebug('Current Chain ID: ' + chainId);
                
                if (chainId !== BSC_MAINNET && chainId !== BSC_TESTNET) {
                    const switchToTestnet = confirm(
                        '‚ö†Ô∏è –ù–µ —Å–∏ –Ω–∞ BNB Smart Chain!\n\n' +
                        '–¢–µ–∫—É—â–∞ –º—Ä–µ–∂–∞: Chain ID ' + chainId + '\n\n' +
                        '–ù–∞—Ç–∏—Å–Ω–∏ OK –∑–∞ BSC Testnet\n' +
                        '–ù–∞—Ç–∏—Å–Ω–∏ Cancel –∑–∞ BSC Mainnet'
                    );
                    
                    try {
                        const targetChainId = switchToTestnet ? '0x61' : '0x38';
                        updateDebug('üîÑ Switching to chain: ' + targetChainId);
                        
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: targetChainId }],
                        });
                        
                        updateDebug('‚úÖ Network switched!');
                        
                    } catch (switchError) {
                        updateDebug('‚ùå Switch error: ' + switchError.message);
                        
                        // Network not added, try to add it
                        if (switchError.code === 4902) {
                            try {
                                updateDebug('‚ûï Adding network...');
                                
                                const networkParams = switchToTestnet ? {
                                    chainId: '0x61',
                                    chainName: 'BSC Testnet',
                                    nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
                                    rpcUrls: ['https://data-seed-prebsc-1-s1.binance.org:8545/'],
                                    blockExplorerUrls: ['https://testnet.bscscan.com']
                                } : {
                                    chainId: '0x38',
                                    chainName: 'BSC Mainnet',
                                    nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
                                    rpcUrls: ['https://bsc-dataseed.binance.org/'],
                                    blockExplorerUrls: ['https://bscscan.com']
                                };
                                
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [networkParams]
                                });
                                
                                updateDebug('‚úÖ Network added!');
                                
                            } catch (addError) {
                                updateDebug('‚ùå Add network error: ' + addError.message);
                                showStatus('‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤—è–Ω–µ –Ω–∞ –º—Ä–µ–∂–∞: ' + addError.message, 'error');
                                return;
                            }
                        } else {
                            showStatus('‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å–º—è–Ω–∞ –Ω–∞ –º—Ä–µ–∂–∞: ' + switchError.message, 'error');
                            return;
                        }
                    }
                }
                
                // Get final chain after possible switch
                const finalChainId = await web3.eth.getChainId();
                const networkName = finalChainId === BSC_MAINNET ? 'BSC Mainnet' : 'BSC Testnet';
                
                updateDebug('‚úÖ Final network: ' + networkName);
                
                // Save to localStorage
                localStorage.setItem('walletConnected', 'true');
                localStorage.setItem('walletAddress', account);
                
                // Show success
                showStatus(
                    `‚úÖ –°–≤—ä—Ä–∑–∞–Ω —É—Å–ø–µ—à–Ω–æ –Ω–∞ ${networkName}!\n\n` +
                    `–ê–¥—Ä–µ—Å: ${account.substring(0, 10)}...${account.substring(32)}`,
                    'connected'
                );
                
                // Update button
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('btnText').textContent = '‚úÖ –°–≤—ä—Ä–∑–∞–Ω';
                
            } catch (error) {
                updateDebug('‚ùå Error: ' + error.message);
                updateDebug('Error code: ' + error.code);
                
                let errorMsg = '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ';
                
                if (error.code === 4001) {
                    errorMsg = '–û—Ç–∫–∞–∑–∞ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ—Ç–æ';
                } else if (error.code === -32002) {
                    errorMsg = '–í–µ—á–µ –∏–º–∞ pending request –≤ MetaMask. –ü—Ä–æ–≤–µ—Ä–∏ MetaMask –ø—Ä–æ–∑–æ—Ä–µ—Ü–∞!';
                } else {
                    errorMsg = error.message;
                }
                
                showStatus('‚ùå ' + errorMsg, 'error');
            }
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.style.display = 'block';
            
            status.classList.remove('connected', 'error');
            if (type === 'connected') {
                status.classList.add('connected');
            } else if (type === 'error') {
                status.classList.add('error');
            }
        }
        
        // Listen for account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length > 0) {
                    account = accounts[0];
                    showStatus(`‚úÖ –°–º–µ–Ω–µ–Ω account: ${account.substring(0, 10)}...${account.substring(32)}`, 'connected');
                    localStorage.setItem('walletAddress', account);
                } else {
                    localStorage.removeItem('walletConnected');
                    localStorage.removeItem('walletAddress');
                    showStatus('‚ö†Ô∏è Wallet –µ disconnected', 'error');
                }
            });
            
            window.ethereum.on('chainChanged', function () {
                window.location.reload();
            });
        }
    </script>
</body>
</html>
